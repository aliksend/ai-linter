# AI Linter — Design Document

**Date:** 2026-02-20

## Overview

AI Linter — CLI-инструмент, который проверяет код на соответствие правилам, описанным в `.ai-linter.md` файлах, используя AI (Claude) для анализа.

## Core Concepts

- **Файл правил:** `.ai-linter.md` — скрытый файл в любой директории проекта
- **Область действия:** каждый `.ai-linter.md` создаёт отдельную сессию проверки для своей директории и всех вложенных. Правила не наследуются и не объединяются между уровнями
- **Двухпроходная схема:** быстрое сканирование дешёвой моделью → верификация дорогой моделью
- **AI backend:** `claude -p` как сабпроцесс (Claude Code CLI)

## Architecture

```
ai-linter [path] [flags]
     │
     ▼
┌─────────────────────────┐
│  1. Найти все            │
│     .ai-linter.md       │
│     рекурсивно          │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  2. Первый проход       │
│     N параллельных      │
│     `claude -p`         │
│     (Haiku)             │
│     Каждый файл правил  │
│     = отдельная сессия  │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  3. Собрать все          │
│     потенциальные       │
│     проблемы (JSON)     │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  4. Второй проход       │
│     Каждая проблема     │
│     отдельно в          │
│     `claude -p`         │
│     (Sonnet)            │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  5. Сформировать        │
│     MD-отчёт            │
│     + exit code         │
└─────────────────────────┘
```

- Параллельность ограничена флагом `--concurrency` (по умолчанию 5)
- Оба прохода параллельные (первый — по файлам правил, второй — по проблемам)
- `claude -p` запускается с `--model` и `--output-format json`
- Рабочая директория для сабпроцесса — директория с `.ai-linter.md`

## CLI Interface

```
ai-linter [path] [options]
```

| Флаг | По умолчанию | Описание |
|------|-------------|----------|
| `path` | `.` | Корень проекта для проверки |
| `--concurrency, -c` | `5` | Макс. параллельных сессий Claude |
| `--model-fast` | `haiku` | Модель для первого прохода |
| `--model-review` | `sonnet` | Модель для второго прохода |
| `--output, -o` | `ai-linter-report.md` | Путь к файлу отчёта |
| `--verbose, -v` | `false` | Подробный вывод прогресса |

**Exit codes:**
- `0` — нет ошибок (могут быть warnings)
- `1` — найдены ошибки (errors)
- `2` — ошибка самого инструмента (не удалось запустить claude и т.д.)

## Prompts

### First Pass (Haiku — scanning)

```
Ты AI-линтер. Твоя задача — проверить код в текущей директории
на соответствие правилам, описанным ниже.

ПРАВИЛА:
---
{содержимое .ai-linter.md}
---

Инструкции:
1. Изучи файлы в текущей директории и вложенных папках
2. Проверь код на соответствие каждому правилу
3. Для каждого нарушения определи severity:
   - "error" — явное нарушение запрета или обязательного требования
   - "warning" — нарушение рекомендации или потенциальная проблема

Верни ТОЛЬКО валидный JSON (без markdown):
{
  "issues": [
    {
      "file": "path/to/file.ts",
      "line": "42" или "20-45",
      "severity": "error",
      "rule": "краткое название правила",
      "description": "что не так (1 предложение)"
    }
  ]
}

Если нарушений нет, верни: {"issues": []}
```

### Second Pass (Sonnet — verification)

```
Ты опытный ревьюер кода. Проверь, действительно ли это нарушение правил.

ПРАВИЛО: {rule из первого прохода}
ФАЙЛ: {file}
ОПИСАНИЕ ПРОБЛЕМЫ: {description из первого прохода}

Инструкции:
1. Прочитай указанный файл
2. Проанализируй, действительно ли описанная проблема существует
3. Если это ложное срабатывание — верни {"confirmed": false}

Верни ТОЛЬКО валидный JSON:
- Если проблема подтверждена:
{
  "confirmed": true,
  "severity": "error" | "warning",
  "file": "path/to/file.ts",
  "line": "42" или "20-45",
  "rule": "название правила",
  "explanation": "подробное объяснение проблемы и как её исправить (2-3 предложения)"
}
- Если ложное срабатывание:
{"confirmed": false}
```

Неподтверждённые проблемы (`confirmed: false`) полностью отбрасываются.

## Project Structure

```
ai-linter/
├── package.json
├── tsconfig.json
├── src/
│   ├── index.ts            # CLI entry point (парсинг аргументов)
│   ├── scanner.ts          # Поиск .ai-linter.md файлов рекурсивно
│   ├── runner.ts           # Запуск claude -p сабпроцессов
│   ├── passes/
│   │   ├── first-pass.ts   # Логика первого прохода (сканирование)
│   │   └── second-pass.ts  # Логика второго прохода (верификация)
│   ├── report.ts           # Генерация MD-отчёта
│   └── types.ts            # TypeScript типы (Issue, Config и т.д.)
└── bin/
    └── ai-linter.js        # Shebang entry point
```

## Report Format

```markdown
# AI Linter Report

**Дата:** 2026-02-20 12:34:56
**Проект:** /path/to/project
**Найдено:** 3 errors, 2 warnings

---

## Errors (3)

### `src/api/routes.ts`

- **Строка 42** — [Запрещённая библиотека] Используется `import foo from 'foo'`,
  но правила проекта запрещают использование библиотеки foo.
  Удалите импорт и замените на встроенную реализацию.

- **Строки 20-45** — [Отсутствует swagger-документация] Роут `POST /users`
  не имеет соответствующей swagger-аннотации.
  Добавьте декоратор @ApiOperation с описанием эндпоинта.

### `src/models/user.ts`

- **Строка 15** — [Бизнес-логика в модели] Метод `calculateDiscount()`
  содержит бизнес-логику, но папка models должна содержать только методы
  доступа к БД. Перенесите метод в сервисный слой.

---

## Warnings (2)

### `src/utils/helpers.ts`

- **Строка 3** — [Неиспользуемый импорт] `lodash` импортирован целиком,
  рекомендуется использовать точечные импорты для уменьшения бандла.

### `src/api/middleware.ts`

- **Строки 28-35** — [Обработка ошибок] Общий catch-блок без типизации
  ошибки. Рекомендуется использовать типизированные ошибки.
```

## Technology Stack

- **Language:** TypeScript (Node.js)
- **CLI parsing:** commander или yargs
- **AI interaction:** `claude -p` через `child_process.spawn`
- **File discovery:** glob / fast-glob
- **Distribution:** npm package с bin entry point
